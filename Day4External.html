
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
          crossorigin="anonymous"></script>
</head>


<body class="container" id="bodyTest">
<h3>All Users</h3>
<div style="height: 300px;overflow-y: scroll;">
  <table class="table">
    <thead>
    <tr>
      <th>Id</th>
      <th>Age</th>
      <th>Name</th>
      <th>Gender</th>
      <th>Email</th>
      <th></th>
      <th></th>
    </tr>
    </thead>
    <tbody id="user-table-body">
    </tbody>
  </table>
</div>
<button type="button" class="btn btn-primary" id="btn-add-user">
  Add new user
</button>
<button type="button" class="btn btn-secondary" id="btn-get-user">
  Get user
</button>
<input type="text" placeholder="Enter id" id="input-id">
<p id="add-error-msg" class="alert alert-danger" style="max-width: 50%;display: none;" role="alert"></p>

<!-- Modal -->
<div class="modal fade" id="user-modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modal-title">Add User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p >User ID: <span id="user-id"></span></p>
        <form>
          <div class="mb-3">
            <label for="input-age" class="form-label">Age</label>
            <input type="number" class="form-control" id="input-age">
          </div>
          <div class="mb-3">
            <label for="input-name" class="form-label">Name</label>
            <input type="text" class="form-control" id="input-name">
          </div>
          <div class="mb-3">
            <label for="input-gender" class="form-label">Gender</label>
            <input type="text" class="form-control" id="input-gender">
          </div>
          <div class="mb-3">
            <label for="input-email" class="form-label">Email</label>
            <input type="text" class="form-control" id="input-email">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">cancel</button>
        <button id="btn-save" type="button" class="btn btn-primary" data-bs-dismiss="modal">Save changes
        </button>
      </div>
    </div>
  </div>
</div>
<!--END OF MODAL -->

<p id="helperP"></p>
</body>
</html>

<script>
  let nextId = 200;
  let users = [
    {id: 100, age: 39, name: "Madeleine Flynn", gender: "female", email: "madeleineflynn@jumpstack.com"},
    {id: 101, age: 34, name: "Cecile Benson", gender: "female", email: "cecilebenson@jumpstack.com"}
  ]

  const URL = "http://localhost:3333/api/users"; // for class
  function setUpHandlers() {
    document.getElementById("user-table-body").onclick = handleTableClick
    document.getElementById("btn-save").onclick = saveUser
    document.getElementById("btn-add-user").onclick = makeNewUser
    document.getElementById('btn-get-user').onclick = getUser
    document.getElementById('bodyTest').onload = fetchUsers
  }
  setUpHandlers()

  function handleTableClick(evt) {
    evt.preventDefault()
    evt.stopPropagation()
    const target = evt.target;

    if (target.dataset.isDelete) {
      alert("Delete "+target.dataset.idDelete)
    }

    if (target.dataset.isEdit) {
      alert(JSON.parse(target.dataset.dataEdit))

    }
  }

  function makeNewUser() {
    showModal({
      id: null,
      age: "",
      name: "",
      gender: "",
      email: ""
    })
  }

  function getUser() {

    let id = document.getElementById('input-id').value;
    if (id === "") {
      alert("Please enter id")
    } else {

      fetch(URL + "/" + id)
              .then(handleHttpErrors)
              .then(data => {
                const user444 = {id: data.id, age: data.age, name: data.name, gender: data.gender, email: data.email}

                showModal(user444)
              }).catch(err => {
                console.log(err);

      })


    }


  }

  function showModal(user) {
    const myModal = new bootstrap.Modal(document.getElementById('user-modal'))
    document.getElementById("modal-title").innerText = user.id ? "Edit User" : "Add User"
    document.getElementById("user-id").innerText = user.id
    document.getElementById("input-age").value = user.age
    document.getElementById("input-name").value = user.name
    document.getElementById("input-gender").value = user.gender
    document.getElementById("input-email").value = user.email
    myModal.show()
  }

  function saveUser() {
    const user = {}
    user.id = Number(document.getElementById("user-id").innerText)
    user.age = document.getElementById("input-age").value
    user.name = document.getElementById("input-name").value
    user.gender = document.getElementById("input-gender").value
    user.email = document.getElementById("input-email").value

    const options = makeOptions("POST", user);

    fetch(URL, options);
    //TODO Save user on server  --> We will do this in the class
    //Figure out how to update local data

    fetchUsers();



  }

  function fetchUsers() {

    fetch(URL)
    .then(res => res.json())
    .then(data => {
      const user = makeRows(data);
      document.getElementById('user-table-body').innerHTML = user;

    })
    // Todo  --> This is one of the things we will do in the class

  }

  function makeRows(array) {
    //make rows from data
      return array.map(user =>
              `<tr><td>${user.id}</td><td>${user.age}</td><td>${user.name}</td><td>${user.gender}</td><td>${user.email}</td></tr>`).join("");

  }






  function handleHttpErrors(res) {
    if (!res.ok) {
      return res.json()
              .then(body => {
                document.getElementById('helperP').innerHTML = "HTTP RESPONSE : " + body.status;
                const error = new Error(body.message)
                error.apiError = body
                throw error
              })
    }
    return res.json()
  }


  function makeOptions(method, body) {
    const opts = {
      method: method,
      headers: {
        "Content-type": "application/json",
        "Accept": "application/json"
      }
    }
    if (body) { //Observe how we can add new fields to an object when needed
      opts.body = JSON.stringify(body);
    }
    return opts;
  }



</script>